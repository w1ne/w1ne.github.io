---
layout: post
title: IoT loco demo
blogid: personal
sticky: false
published: true
author: Andrii Shylenko
date: 2022-12-02
featured-image: 2022-12-02-iot-train/feature-image-train.png
featured-image-alt: iot locomotive
tags: [IoT, demo, loco, power, c, python, architecture]
---

Pablo is a middle-aged train driver, with a round face, brown like the dirt of the freight car eyes, and an evergreen smile. Pablo lives in Spiez, Switzerland.

When Pablo was in sixth grade, the train driver who worked for the local rail company organised the lecture for the kids. 
<img align="right" src="/images/img/2022-12-02-iot-train/pablo.jpg" />
The train driver walked into the class, dressed in his clean blue uniform. He sat at the teacher's desk and told them how beautiful it is to drive a train. Pablo looked at him with fascination, the way that only a twelve-year-old can look at someone. The voice of the train driver sounded like a low mumble of diesel exhaust as he spoke of train tracks and engines.
An image formed in Pablo's mind of a man standing at the controls of a huge black machine, its metal glinting in the sun. It seemed to him that if life were simply a matter of keeping such a machine running smoothly, it would be an excellent life!

In ten years Pablo graduated from the Railroad School of Engineering in Luzern.

Now Pablo drives trains everyday. In rain and sun, he loves trains!
![HWdriving in the rain]({{"/images/img/2022-12-02-iot-train/rain_drive.jpg"|relative_url}}){: .center-image }

#Problem
But there is one thing Pablo hates about his job.

So many kilometers, so many kilometers of peaceful, solitary driving are spoiled by reports.

<img align="left" src="/images/img/2022-12-02-iot-train/boss.jpg" />
Pablo's boss, Mr. Schmetterlink, is a short man with jet-black hair streaked gray. His tiny body always alarmed Pablo with nervous energy. Mr. Schmetterlink demands to fill hundreds of reports. Brake test reports, Engine reports, Safety reports. Reports, reports, and more reports for Pablo.
[reports reports reports! image] 
Mr. Schmetterlink calls Pablo each couple of hours to ask where the train is and how much precious fuel he is burning.
Pablo wants to drive the train, not to fill excel tables with the test data or answer calls about temperature inside the engine manifold.

The Rail industry is still using paper processes. Even though all the data about the train's performance is available in the onboard centralized management system.

How can we help Publo to move from Excel tables to the modern Internet of Things (IoT) solution?

#What train operators want
My last job as an IoT engineer is to get engine and other important data out of the train (using MVB, CAN, Voith and other protocols) to the cloud in order to help people like Pablo and Mr. Schmetterlink.
There are three main things that fleet operators want to know:
1. Where is the loco.
2. How much energy it is using.
3. What mailfunctions and errors are there.

#IoT Demo
I have built a small demonstration project that shows how mentioned loco data can be transferred and processed on the cloud.
[Loco video]

##3D model
The 3d model of EMD GP38 is from the excellent [OS Railway train project] http://depronized.com/2018/02/13/presenting-the-os-railway-system-fully-3d-printed-model-train-system/.
You can check all the designs at [Thingiverse] https://www.thingiverse.com/depronized/designs

##The Hardware
The hardware is of the system is based on ESP32, to measure the current INA218 sensor is used. Skylab SKM53 module is gathering  GPS coordinates and time.
IoT Loco is powered by batteries with voltage up to 12v (maximum voltage for the HalfBridge DC motor driver I am using).

![HW]({{"/images/img/2022-12-02-iot-train/HW.png"|relative_url}}){: .center-image }

##Firmware
Embedded Software
There are three software states 
![HW]({{"/images/img/2022-12-02-iot-train/FW_State_mechine.png"|relative_url}}){: .center-image }

##Connectivity
Server Side
The data is transmitted using wifi connection to my personal MQTT broker.
![Connectivity]({{"/images/img/2022-12-02-iot-train/Connectivity.png"|relative_url}}){: .center-image }
##Dashboard
Server-side application is built using Python Paho and Dash libraries
![Python IoT Dashboard]({{"/images/img/2022-12-02-iot-train/Dashboard.png"|relative_url}}){: .center-image }

# Conclusion
With the IoT Loco Dashboard Pablo can drive his train and do forget about all the Excel processes and calls from Mr. Schmetterlink. The energy dashboard clearly shows how much energy the train is using, along with its GPS location. 

Documentation and code are available on github and distributed under XXX license.



